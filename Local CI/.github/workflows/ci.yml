name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ==============================================================================
  # ðŸŽ¯ LOCAL CI DEMONSTRATION
  # ==============================================================================
  # This job demonstrates the power of Rails 8.1 Local CI:
  # The SAME command that runs locally (bin/ci) runs in GitHub Actions!
  #
  # Benefits:
  # - No duplication between local and CI configurations
  # - Developers can test the exact same CI pipeline locally before pushing
  # - Single source of truth: config/ci.rb defines all CI steps
  # ==============================================================================

  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.3
        bundler-cache: true

    - name: Run CI
      run: bin/ci

  # ==============================================================================
  # ALTERNATIVE: TRADITIONAL APPROACH (Multiple Jobs)
  # ==============================================================================
  # The workflow below shows the traditional GitHub Actions approach with
  # separate jobs for each concern. This works but creates duplication:
  # - You define steps locally (for development)
  # - You define steps again here (for CI)
  # - They can drift out of sync
  #
  # With Rails 8.1 Local CI, you define steps once in config/ci.rb!
  # ==============================================================================

  # scan_ruby:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6
  #
  #     - name: Set up Ruby
  #       uses: ruby/setup-ruby@v1
  #       with:
  #         bundler-cache: true
  #
  #     - name: Scan for common Rails security vulnerabilities
  #       run: bin/brakeman --no-pager
  #
  #     - name: Scan for security vulnerabilities in gems
  #       run: bin/bundler-audit

  # scan_js:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6
  #
  #     - name: Set up Ruby
  #       uses: ruby/setup-ruby@v1
  #       with:
  #         bundler-cache: true
  #
  #     - name: Scan JavaScript dependencies
  #       run: bin/importmap audit

  # lint:
  #   runs-on: ubuntu-latest
  #   env:
  #     RUBOCOP_CACHE_ROOT: tmp/rubocop
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6
  #
  #     - name: Set up Ruby
  #       uses: ruby/setup-ruby@v1
  #       with:
  #         bundler-cache: true
  #
  #     - name: Prepare RuboCop cache
  #       uses: actions/cache@v4
  #       env:
  #         DEPENDENCIES_HASH: ${{ hashFiles('.ruby-version', '**/.rubocop.yml', '**/.rubocop_todo.yml', 'Gemfile.lock') }}
  #       with:
  #         path: ${{ env.RUBOCOP_CACHE_ROOT }}
  #         key: rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-${{ github.ref_name == github.event.repository.default_branch && github.run_id || 'default' }}
  #         restore-keys: |
  #           rubocop-${{ runner.os }}-${{ env.DEPENDENCIES_HASH }}-
  #
  #     - name: Lint code
  #       run: bin/rubocop -f github

  # test:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6
  #
  #     - name: Set up Ruby
  #       uses: ruby/setup-ruby@v1
  #       with:
  #         bundler-cache: true
  #
  #     - name: Run tests
  #       env:
  #         RAILS_ENV: test
  #       run: bin/rails db:test:prepare test

  # system-test:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v6
  #
  #     - name: Set up Ruby
  #       uses: ruby/setup-ruby@v1
  #       with:
  #         bundler-cache: true
  #
  #     - name: Run System Tests
  #       env:
  #         RAILS_ENV: test
  #       run: bin/rails db:test:prepare test:system
  #
  #     - name: Keep screenshots from failed tests
  #       uses: actions/upload-artifact@v4
  #       if: failure()
  #       with:
  #         name: screenshots
  #         path: ${{ github.workspace }}/tmp/screenshots
  #         if-no-files-found: ignore
